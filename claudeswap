#!/usr/bin/env bash

# Claude Swap - Modular Configuration Manager
# Main entry point script with TIGERSTYLE modular architecture

# Bash safety: exit on error, undefined vars, pipe failures
set -euo pipefail

readonly VERSION="1.5.0"

# Determine script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export CLAUDE_SWAP_BASE_DIR="$SCRIPT_DIR"

# Dynamically locate lib directory - works for both Homebrew and source installs
LIB_DIR=""
CLAUDE_SWAP_BASE_DIR="$SCRIPT_DIR"
if [[ -d "$SCRIPT_DIR/lib" ]]; then
    # Source installation: lib/ in same directory as script
    LIB_DIR="$SCRIPT_DIR/lib"
elif [[ -d "/opt/homebrew/Cellar/claudeswap" ]]; then
    # Homebrew installation: find lib/ in the actual Cellar version directory
    # Try to find the most recent version
    latest_version=$(ls -t /opt/homebrew/Cellar/claudeswap 2>/dev/null | head -1)
    if [[ -n "$latest_version" ]]; then
        # Homebrew installs to libexec/lib
        if [[ -d "/opt/homebrew/Cellar/claudeswap/$latest_version/libexec/lib" ]]; then
            LIB_DIR="/opt/homebrew/Cellar/claudeswap/$latest_version/libexec/lib"
            # Also update base dir to libexec so modular files can find dependencies via ${CLAUDE_SWAP_BASE_DIR}/lib/
            CLAUDE_SWAP_BASE_DIR="/opt/homebrew/Cellar/claudeswap/$latest_version/libexec"
        # Fallback for source installs
        elif [[ -d "/opt/homebrew/Cellar/claudeswap/$latest_version/lib" ]]; then
            LIB_DIR="/opt/homebrew/Cellar/claudeswap/$latest_version/lib"
            CLAUDE_SWAP_BASE_DIR="/opt/homebrew/Cellar/claudeswap/$latest_version"
        fi
    fi
fi

# Fallback: use script directory if nothing else works
if [[ -z "$LIB_DIR" ]]; then
    LIB_DIR="$SCRIPT_DIR/lib"
fi

# Guard against multiple sourcing
[[ -z "${CLAUDESWAP_LOADED:-}" ]] || return 0
readonly CLAUDESWAP_LOADED=1

# Source all modular components with absolute paths
# NASA Rule 7: Check file existence before sourcing
for lib_file in "constants.sh" "logging.sh" "utils/cache.sh" "utils/formatter.sh" "models.sh" "sessions.sh" "providers/model_fetch.sh" "credentials.sh" "instance_manager.sh"; do
    if [[ ! -f "$LIB_DIR/$lib_file" ]]; then
        echo "ERROR: Required library file not found: $LIB_DIR/$lib_file" >&2
        exit 1
    fi
    source "$LIB_DIR/$lib_file"
done

# Source TUI components (optional - graceful degradation)
TUI_AVAILABLE=false
if [[ -f "$LIB_DIR/tui/gum_utils.sh" ]] && [[ -f "$LIB_DIR/tui/main_menu.sh" ]]; then
    source "$LIB_DIR/tui/gum_utils.sh"
    if check_gum_installed; then
        TUI_AVAILABLE=true
        source "$LIB_DIR/tui/main_menu.sh"
    fi
fi

# ============================================================================
# COMMAND HANDLERS
# ============================================================================

handle_status() {
    local current_provider=""
    local current_model=""

    # Detect current provider
    if [[ -f "$SETTINGS_FILE" ]]; then
        current_provider=$(jq -r '.env.ANTHROPIC_AUTH_TOKEN // empty' "$SETTINGS_FILE" 2>/dev/null | grep -q "sk-ant" && echo "standard" || echo "unknown")
        if [[ "$current_provider" == "unknown" ]] && [[ -n "${ZAI_API_KEY:-}" ]]; then
            current_provider="zai"
        fi
        if [[ "$current_provider" == "unknown" ]] && [[ -n "${MINIMAX_API_KEY:-}" ]]; then
            current_provider="minimax"
        fi
        if [[ "$current_provider" == "unknown" ]] && [[ -n "${KIMI_API_KEY:-}" ]]; then
            current_provider="kimi"
        fi
    fi

    # Get current model
    if [[ -d "$CLAUDE_SESSION_DIR" ]] && [[ "$(ls -A "$CLAUDE_SESSION_DIR" 2>/dev/null)" ]]; then
        local latest_session=$(ls -t "$CLAUDE_SESSION_DIR"/*.json 2>/dev/null | head -1)
        if [[ -n "$latest_session" ]]; then
            current_model=$(extract_session_model "$latest_session")
        fi
    fi

    # Display status
    echo ""
    echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "â”‚           CLAUDE SWAP STATUS             â”‚"
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    echo "â”‚ Provider:  ${current_provider:-none}                â”‚"
    echo "â”‚ Model:     ${current_model:-unknown}           â”‚"
    echo "â”‚ Sessions:  $(ls -1 "$CLAUDE_SESSION_DIR"/*.json 2>/dev/null | wc -l | tr -d ' ') session files              â”‚"
    echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo ""

    # Show available providers
    echo "Available providers:"
    echo "  â€¢ standard - Anthropic API (claude-3-5-sonnet, claude-3-haiku)"
    echo "  â€¢ zai      - Z.ai API (GLM models: glm-4.6, glm-4.5)"
    echo "  â€¢ minimax  - MiniMax API (MiniMax-M2, MiniMax-M1)"
    echo "  â€¢ kimi     - Kimi/Moonshot API (moonshot-v1-256k, kimi-k2)"
    echo ""
}

handle_test_models() {
    local provider="${1:-}"
    local models=()
    local max_providers=10  # NASA Rule 2: Fixed loop bound

    if [[ -z "$provider" ]]; then
        log_info "Testing all providers..."
        local count=0
        for prov in standard zai minimax kimi; do
            if [[ $count -ge $max_providers ]]; then
                break
            fi
            log_info "Checking $prov models..."
            local prov_models=($(fetch_available_models "$prov"))
            echo "  $prov: ${prov_models[*]:-none}"
            count=$((count + 1))
        done
    else
        models=($(fetch_available_models "$provider"))
        echo "Available models for $provider:"
        local max_models=100  # NASA Rule 2: Fixed loop bound
        local idx=0
        for model in "${models[@]}"; do
            if [[ $idx -ge $max_models ]]; then
                break
            fi
            echo "  â€¢ $model$(get_model_details "$model" "$provider")"
            idx=$((idx + 1))
        done
    fi
}

handle_set() {
    local provider="$1"
    local model="${2:-}"

    validate_provider "$provider" || return 1

    # Map model to provider's equivalent
    if [[ -n "$model" ]]; then
        model=$(map_model_to_provider "$model" "$provider")
    fi

    case "$provider" in
        "standard")
            setup_anthropic_credentials
            ;;
        "zai")
            setup_zai_credentials
            ;;
        "minimax")
            setup_minimax_credentials
            ;;
        "kimi")
            setup_kimi_credentials
            ;;
    esac

    # Update settings file with correct auth token path
    if [[ ! -d "$(dirname "$SETTINGS_FILE")" ]]; then
        mkdir -p "$(dirname "$SETTINGS_FILE")"
    fi

    # Ensure settings file exists with proper structure
    if [[ ! -f "$SETTINGS_FILE" ]]; then
        echo '{"env":{"ANTHROPIC_AUTH_TOKEN":"","API_TIMEOUT_MS":"120000"}}' > "$SETTINGS_FILE"
    fi

    # Update authentication token based on provider
    local auth_token=""
    local timeout_ms=""
    local base_url=""

    case "$provider" in
        "standard")
            auth_token="${ANTHROPIC_API_KEY:-}"
            timeout_ms="${STANDARD_TIMEOUT:-120000}"
            base_url=""  # Standard Anthropic uses default API endpoint (no BASE_URL key)
            ;;
        "zai")
            auth_token="${ZAI_API_KEY:-}"
            timeout_ms="${ZAI_TIMEOUT:-3000000}"
            base_url="${ZAI_BASE_URL:-$ZAI_BASE_URL_DEFAULT}"
            ;;
        "minimax")
            auth_token="${MINIMAX_API_KEY:-}"
            timeout_ms="${MINIMAX_TIMEOUT:-3000000}"
            base_url="${MINIMAX_BASE_URL:-$MINIMAX_BASE_URL_DEFAULT}"
            ;;
        "kimi")
            auth_token="${KIMI_API_KEY:-}"
            timeout_ms="${KIMI_TIMEOUT:-3000000}"
            base_url="${KIMI_BASE_URL:-$KIMI_BASE_URL_DEFAULT}"
            ;;
    esac

    if [[ -z "$auth_token" ]]; then
        log_error "No authentication token available for $provider"
        log_info "Run: claudeswap setup"
        return 1
    fi

    # Update settings.json with provider-specific configuration
    # NASA Rule 7: Check all return values
    # Security: Use jq --arg to prevent injection
    # Security: Use mktemp for atomic temp file handling
    local temp_file
    temp_file=$(mktemp "${SETTINGS_FILE}.XXXXXX") || {
        log_error "Failed to create temporary file"
        return 1
    }

    # Set up cleanup trap
    trap "rm -f '$temp_file'" RETURN

    local jq_result=0
    if [[ -n "$base_url" ]]; then
        # Proxy providers (Z.ai, MiniMax, Kimi): Set ANTHROPIC_BASE_URL
        jq --arg token "$auth_token" --arg timeout "$timeout_ms" --arg url "$base_url" \
            '.env.ANTHROPIC_AUTH_TOKEN = $token | .env.API_TIMEOUT_MS = $timeout | .env.ANTHROPIC_BASE_URL = $url' \
            "$SETTINGS_FILE" > "$temp_file"
        jq_result=$?
    else
        # Standard Anthropic: Remove ANTHROPIC_BASE_URL if it exists
        jq --arg token "$auth_token" --arg timeout "$timeout_ms" \
            '.env.ANTHROPIC_AUTH_TOKEN = $token | .env.API_TIMEOUT_MS = $timeout | del(.env.ANTHROPIC_BASE_URL)' \
            "$SETTINGS_FILE" > "$temp_file"
        jq_result=$?
    fi

    if [[ $jq_result -eq 0 ]]; then
        # Atomic move
        if ! mv "$temp_file" "$SETTINGS_FILE"; then
            log_error "Failed to save settings file"
            return 1
        fi
        log_success "Switched to $provider$([[ -n "$model" ]] && echo " (model: $model)")$([[ -n "$base_url" ]] && echo " at $base_url")"
    else
        log_error "Failed to update settings file"
        return 1
    fi
    return 0
}

handle_setup() {
    # NASA Rule 7: Check return value
    if ! setup_credentials_interactive; then
        log_error "Setup failed or was cancelled"
        return 1
    fi
    return 0
}

handle_backup() {
    # NASA Rule 7: Check return values
    if ! create_session_backup_dir; then
        log_error "Failed to create backup directory"
        return 1
    fi

    local backup_path=$(backup_sessions)
    if [[ -n "$backup_path" ]]; then
        log_success "Sessions backed up to: $backup_path"
        return 0
    fi
    return 1
}

handle_clear() {
    # NASA Rule 7: Check return value
    if ! clear_sessions; then
        log_error "Failed to clear sessions"
        return 1
    fi
    return 0
}

# ============================================================================
# VALIDATION FUNCTIONS
# ============================================================================

validate_provider() {
    local provider="$1"

    case "$provider" in
        standard|zai|minimax|kimi|moonshot)
            return 0
            ;;
        *)
            log_error "Invalid provider: $provider"
            log_info "Valid providers: standard, zai, minimax, kimi"
            return 1
            ;;
    esac
}

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

# Check if any credentials are configured
check_credentials_configured() {
    # Check for standard Anthropic key
    if [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
        return 0
    fi

    # Check settings file
    if [[ -f "$SETTINGS_FILE" ]]; then
        local token
        token=$(jq -r '.env.ANTHROPIC_AUTH_TOKEN // empty' "$SETTINGS_FILE" 2>/dev/null)
        if [[ -n "$token" ]] && [[ "$token" != "null" ]]; then
            return 0
        fi
    fi

    # Check for alternative provider keys
    if [[ -n "${ZAI_API_KEY:-}" ]] || [[ -n "${MINIMAX_API_KEY:-}" ]] || [[ -n "${KIMI_API_KEY:-}" ]]; then
        return 0
    fi

    return 1
}

# Show first-run welcome and offer setup
show_first_run_welcome() {
    if [[ "$TUI_AVAILABLE" == true ]]; then
        gum style \
            --border rounded \
            --border-foreground 212 \
            --padding "1 2" \
            --margin "1" \
            --align center \
            "Welcome to ClaudeSwap! ðŸŽ‰" \
            "" \
            "It looks like you haven't set up any API credentials yet." \
            "Would you like to configure them now?"

        if gum confirm "Run credential setup?"; then
            handle_setup
        else
            gum style --foreground 214 "You can run setup later with: claudeswap setup"
        fi
    else
        echo ""
        echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"
        echo "â”‚       Welcome to ClaudeSwap! ðŸŽ‰             â”‚"
        echo "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯"
        echo ""
        log_warning "No API credentials configured."
        log_info "Run 'claudeswap setup' to configure your credentials."
        echo ""
    fi
}

# ============================================================================
# MAIN ENTRY POINT
# ============================================================================

main() {
    local command="${1:-}"

    # Check for first run (no credentials configured) and offer setup
    if [[ -z "$command" ]] && ! check_credentials_configured; then
        show_first_run_welcome
        if [[ "$TUI_AVAILABLE" == true ]]; then
            # After setup, enter TUI mode
            run_tui_main_loop
            return $?
        fi
        return 0
    fi

    # Handle TUI mode - if no command and TUI available, enter TUI mode
    if [[ -z "$command" ]] && [[ "$TUI_AVAILABLE" == true ]]; then
        run_tui_main_loop
        return $?
    fi

    shift || true

    case "$command" in
        "tui"|"--tui")
            # Explicit TUI mode request
            if [[ "$TUI_AVAILABLE" == true ]]; then
                run_tui_main_loop
            else
                if ! check_gum_installed; then
                    show_gum_install_instructions
                else
                    log_error "TUI components not found"
                fi
                return 1
            fi
            ;;
        "--no-tui")
            # Disable TUI mode and show help
            if [[ $# -eq 0 ]]; then
                log_error "No command specified (TUI mode disabled)"
                echo "Use 'claudeswap help' for usage information"
                return 1
            fi
            # Process next argument as command
            main "$@"
            ;;
        "status")
            handle_status
            ;;
        "test-models")
            handle_test_models "$@"
            ;;
        "set")
            if [[ $# -lt 1 ]]; then
                log_error "Usage: claudeswap set <provider> [model]"
                return 1
            fi
            handle_set "$@"
            ;;
        "setup")
            handle_setup
            ;;
        "backup")
            handle_backup
            ;;
        "clear")
            handle_clear
            ;;
        "instances"|"list")
            # List all provider instances
            list_instances | column -t -s'|'
            ;;
        "init")
            # Initialize instance for a provider
            if [[ $# -lt 1 ]]; then
                log_error "Usage: claudeswap init <provider>"
                return 1
            fi
            init_instance "$1"
            ;;
        "activate")
            # Activate a provider instance
            if [[ $# -lt 1 ]]; then
                log_error "Usage: claudeswap activate <provider>"
                return 1
            fi
            activate_instance "$1"
            ;;
        "exec")
            # Execute command with provider switch
            # Usage: claudeswap exec <provider> <command...>
            if [[ $# -lt 2 ]]; then
                log_error "Usage: claudeswap exec <provider> <command...>"
                return 1
            fi
            local exec_provider="$1"
            shift

            # Activate instance
            activate_instance "$exec_provider" || return 1

            # Detect Claude CLI path
            local claude_cmd="${CLAUDESWAP_CLAUDE_PATH:-claude}"
            if ! command -v "$claude_cmd" >/dev/null 2>&1; then
                log_error "Claude CLI not found. Set CLAUDESWAP_CLAUDE_PATH if needed."
                return 1
            fi

            # Execute command
            log_info "Executing with provider: $exec_provider"
            "$claude_cmd" "$@"
            ;;
        "version"|"--version"|"-v")
            echo "claudeswap version $VERSION"
            if [[ "$TUI_AVAILABLE" == true ]]; then
                echo "TUI mode: available"
            else
                echo "TUI mode: not available (install gum: brew install gum)"
            fi
            ;;
        "help"|"--help"|"-h")
            echo "Claude Swap - Multi-Provider Configuration Manager"
            echo ""
            echo "Usage: claudeswap [command] [options]"
            echo ""
            echo "Commands:"
            echo "  tui                Launch interactive TUI mode (default if no command)"
            echo "  status             Show current configuration status"
            echo "  test-models        Test and display available models"
            echo "  set <provider>     Switch to specified provider"
            echo "  setup              Interactive credential setup"
            echo "  backup             Backup current sessions"
            echo "  clear              Clear all sessions"
            echo ""
            echo "Instance Management (CCS-style):"
            echo "  instances / list   List all provider instances"
            echo "  init <provider>    Initialize isolated instance for provider"
            echo "  activate <prov>    Activate a provider instance"
            echo "  exec <prov> <cmd>  Execute Claude command with provider"
            echo "  <provider> [cmd]   Direct execution (shorthand for exec)"
            echo ""
            echo "Options:"
            echo "  --tui              Explicitly enter TUI mode"
            echo "  --no-tui           Disable TUI mode"
            echo ""
            echo "Supported Providers:"
            echo "  standard           Anthropic official API"
            echo "  zai                Z.ai / GLM models"
            echo "  kimi / moonshot    Moonshot AI (256K context, general use)"
            echo "  kimi-for-coding    Kimi optimized for coding tasks"
            echo "  minimax            MiniMax models"
            echo ""
            echo "Examples:"
            echo "  claudeswap                        # Enter TUI mode"
            echo "  claudeswap status                 # Show status"
            echo "  claudeswap set kimi               # Switch to Kimi"
            echo "  claudeswap kimi \"write code\"      # Execute with Kimi (CCS-style)"
            echo "  claudeswap kimi-for-coding \"implement auth\"  # Coding-optimized Kimi"
            echo "  claudeswap exec zai \"fix bug\"     # Execute with Z.ai"
            echo "  claudeswap instances              # List all instances"
            echo ""
            echo "Environment Variables:"
            echo "  CLAUDESWAP_CLAUDE_PATH            Custom Claude CLI path"
            echo "  CLAUDESWAP_TUI_MODE               TUI mode: auto/always/never"
            echo "  CLAUDESWAP_INSTALL_DIR            Installation directory"
            echo ""
            if [[ "$TUI_AVAILABLE" == true ]]; then
                echo "TUI Mode: âœ“ Available (Gum installed)"
            else
                echo "TUI Mode: âœ— Not available (install: brew install gum)"
            fi
            echo ""
            echo "Installation:"
            echo "  curl -fsSL https://raw.githubusercontent.com/sachicali/homebrew-claudeswap/main/install.sh | bash"
            echo ""
            ;;
        standard|zai|kimi|kimi-for-coding|minimax|moonshot)
            # Direct provider execution (CCS-style)
            # Usage: claudeswap <provider> [command...]
            if [[ $# -gt 0 ]]; then
                # Has additional arguments - execute with provider
                log_info "Direct execution mode: $command"
                activate_instance "$command" || return 1

                # Detect Claude CLI
                local claude_cmd="${CLAUDESWAP_CLAUDE_PATH:-claude}"
                if ! command -v "$claude_cmd" >/dev/null 2>&1; then
                    log_error "Claude CLI not found. Set CLAUDESWAP_CLAUDE_PATH if needed."
                    return 1
                fi

                # Execute command
                "$claude_cmd" "$@"
            else
                # No additional arguments - just switch provider
                handle_set "$command"
            fi
            ;;
        *)
            if [[ -z "$command" ]]; then
                log_error "No command specified and TUI mode not available"
                echo "Install Gum for TUI mode: brew install gum"
            else
                log_error "Unknown command: $command"
            fi
            echo "Use 'claudeswap help' for usage information"
            return 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"
