#!/usr/bin/env bash

# Claude Swap - Modular Configuration Manager
# Main entry point script with TIGERSTYLE modular architecture

readonly VERSION="1.2.6"

# Determine script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export CLAUDE_SWAP_BASE_DIR="$SCRIPT_DIR"

# Dynamically locate lib directory - works for both Homebrew and source installs
LIB_DIR=""
CLAUDE_SWAP_BASE_DIR="$SCRIPT_DIR"
if [[ -d "$SCRIPT_DIR/lib" ]]; then
    # Source installation: lib/ in same directory as script
    LIB_DIR="$SCRIPT_DIR/lib"
elif [[ -d "/opt/homebrew/Cellar/claudeswap" ]]; then
    # Homebrew installation: find lib/ in the actual Cellar version directory
    # Try to find the most recent version
    latest_version=$(ls -t /opt/homebrew/Cellar/claudeswap 2>/dev/null | head -1)
    if [[ -n "$latest_version" ]]; then
        # Homebrew installs to libexec/lib
        if [[ -d "/opt/homebrew/Cellar/claudeswap/$latest_version/libexec/lib" ]]; then
            LIB_DIR="/opt/homebrew/Cellar/claudeswap/$latest_version/libexec/lib"
            # Also update base dir to libexec so modular files can find dependencies via ${CLAUDE_SWAP_BASE_DIR}/lib/
            CLAUDE_SWAP_BASE_DIR="/opt/homebrew/Cellar/claudeswap/$latest_version/libexec"
        # Fallback for source installs
        elif [[ -d "/opt/homebrew/Cellar/claudeswap/$latest_version/lib" ]]; then
            LIB_DIR="/opt/homebrew/Cellar/claudeswap/$latest_version/lib"
            CLAUDE_SWAP_BASE_DIR="/opt/homebrew/Cellar/claudeswap/$latest_version"
        fi
    fi
fi

# Fallback: use script directory if nothing else works
if [[ -z "$LIB_DIR" ]]; then
    LIB_DIR="$SCRIPT_DIR/lib"
fi

# Guard against multiple sourcing
[[ -z "${CLAUDESWAP_LOADED:-}" ]] || return 0
readonly CLAUDESWAP_LOADED=1

# Source all modular components with absolute paths
source "$LIB_DIR/constants.sh"
source "$LIB_DIR/logging.sh"
source "$LIB_DIR/utils/cache.sh"
source "$LIB_DIR/utils/formatter.sh"
source "$LIB_DIR/models.sh"
source "$LIB_DIR/sessions.sh"
source "$LIB_DIR/providers/model_fetch.sh"
source "$LIB_DIR/credentials.sh"

# ============================================================================
# COMMAND HANDLERS
# ============================================================================

handle_status() {
    local current_provider=""
    local current_model=""

    # Detect current provider
    if [[ -f "$SETTINGS_FILE" ]]; then
        current_provider=$(jq -r '.anthropic.api_key // empty' "$SETTINGS_FILE" 2>/dev/null | grep -q "sk-ant" && echo "standard" || echo "unknown")
        if [[ "$current_provider" == "unknown" ]] && [[ -n "$ZAI_API_KEY" ]]; then
            current_provider="zai"
        fi
        if [[ "$current_provider" == "unknown" ]] && [[ -n "$MINIMAX_API_KEY" ]]; then
            current_provider="minimax"
        fi
    fi

    # Get current model
    if [[ -d "$CLAUDE_SESSION_DIR" ]] && [[ "$(ls -A "$CLAUDE_SESSION_DIR" 2>/dev/null)" ]]; then
        local latest_session=$(ls -t "$CLAUDE_SESSION_DIR"/*.json 2>/dev/null | head -1)
        if [[ -n "$latest_session" ]]; then
            current_model=$(extract_session_model "$latest_session")
        fi
    fi

    # Display status
    echo ""
    echo "┌──────────────────────────────────────────┐"
    echo "│           CLAUDE SWAP STATUS             │"
    echo "├──────────────────────────────────────────┤"
    echo "│ Provider:  ${current_provider:-none}                │"
    echo "│ Model:     ${current_model:-unknown}           │"
    echo "│ Sessions:  $(ls -1 "$CLAUDE_SESSION_DIR"/*.json 2>/dev/null | wc -l | tr -d ' ') session files              │"
    echo "└──────────────────────────────────────────┘"
    echo ""

    # Show available providers
    echo "Available providers:"
    echo "  • standard - Anthropic API (claude-3-5-sonnet, claude-3-haiku)"
    echo "  • zai      - Z.ai API (GLM models: glm-4.6, glm-4.5)"
    echo "  • minimax  - MiniMax API (MiniMax-M2, MiniMax-M1)"
    echo ""
}

handle_test_models() {
    local provider="${1:-}"
    local models=()

    if [[ -z "$provider" ]]; then
        log_info "Testing all providers..."
        for prov in standard zai minimax; do
            log_info "Checking $prov models..."
            local prov_models=($(fetch_available_models "$prov"))
            echo "  $prov: ${prov_models[*]:-none}"
        done
    else
        models=($(fetch_available_models "$provider"))
        echo "Available models for $provider:"
        for model in "${models[@]}"; do
            echo "  • $model$(get_model_details "$model" "$provider")"
        done
    fi
}

handle_set() {
    local provider="$1"
    local model="$2"

    validate_provider "$provider" || return 1

    # Map model to provider's equivalent
    if [[ -n "$model" ]]; then
        model=$(map_model_to_provider "$model" "$provider")
    fi

    case "$provider" in
        "standard")
            setup_anthropic_credentials
            ;;
        "zai")
            setup_zai_credentials
            ;;
        "minimax")
            setup_minimax_credentials
            ;;
    esac

    # Update settings file with correct auth token path
    if [[ ! -d "$(dirname "$SETTINGS_FILE")" ]]; then
        mkdir -p "$(dirname "$SETTINGS_FILE")"
    fi

    # Ensure settings file exists with proper structure
    if [[ ! -f "$SETTINGS_FILE" ]]; then
        echo '{"env":{"ANTHROPIC_AUTH_TOKEN":"","API_TIMEOUT_MS":"120000"}}' > "$SETTINGS_FILE"
    fi

    # Update authentication token based on provider
    local auth_token=""
    local timeout_ms=""

    case "$provider" in
        "standard")
            auth_token="${ANTHROPIC_API_KEY:-}"
            timeout_ms="${STANDARD_TIMEOUT:-120000}"
            ;;
        "zai")
            auth_token="${ZAI_API_KEY:-}"
            timeout_ms="${ZAI_TIMEOUT:-3000000}"
            ;;
        "minimax")
            auth_token="${MINIMAX_API_KEY:-}"
            timeout_ms="${MINIMAX_TIMEOUT:-3000000}"
            ;;
    esac

    if [[ -z "$auth_token" ]]; then
        log_error "No authentication token available for $provider"
        log_info "Run: claudeswap setup"
        return 1
    fi

    # Update settings.json with correct path (env.ANTHROPIC_AUTH_TOKEN)
    jq ".env.ANTHROPIC_AUTH_TOKEN = \"$auth_token\" | .env.API_TIMEOUT_MS = \"$timeout_ms\"" "$SETTINGS_FILE" > "${SETTINGS_FILE}.tmp"
    if [[ $? -eq 0 ]]; then
        mv "${SETTINGS_FILE}.tmp" "$SETTINGS_FILE"
        log_success "Switched to $provider$([[ -n "$model" ]] && echo " (model: $model)")"
    else
        log_error "Failed to update settings file"
        rm -f "${SETTINGS_FILE}.tmp"
        return 1
    fi
}

handle_setup() {
    setup_credentials_interactive
}

handle_backup() {
    create_session_backup_dir
    local backup_path=$(backup_sessions)
    if [[ -n "$backup_path" ]]; then
        log_success "Sessions backed up to: $backup_path"
    fi
}

handle_clear() {
    clear_sessions
}

# ============================================================================
# VALIDATION FUNCTIONS
# ============================================================================

validate_provider() {
    local provider="$1"

    case "$provider" in
        standard|zai|minimax)
            return 0
            ;;
        *)
            log_error "Invalid provider: $provider"
            log_info "Valid providers: standard, zai, minimax"
            return 1
            ;;
    esac
}

# ============================================================================
# MAIN ENTRY POINT
# ============================================================================

main() {
    local command="${1:-}"
    shift || true

    case "$command" in
        "status")
            handle_status
            ;;
        "test-models")
            handle_test_models "$@"
            ;;
        "set")
            if [[ $# -lt 1 ]]; then
                log_error "Usage: claudeswap set <provider> [model]"
                return 1
            fi
            handle_set "$@"
            ;;
        "setup")
            handle_setup
            ;;
        "backup")
            handle_backup
            ;;
        "clear")
            handle_clear
            ;;
        "version"|"--version"|"-v")
            echo "claudeswap version $VERSION"
            ;;
        "help"|"--help"|"-h")
            echo "Claude Swap - Configuration Manager"
            echo ""
            echo "Usage: claudeswap <command> [options]"
            echo ""
            echo "Commands:"
            echo "  status         Show current configuration status"
            echo "  test-models    Test and display available models"
            echo "  set <provider> Switch to specified provider"
            echo "  setup          Interactive credential setup"
            echo "  backup         Backup current sessions"
            echo "  clear          Clear all sessions"
            echo "  version        Show version information"
            echo "  help           Show this help message"
            echo ""
            echo "Examples:"
            echo "  claudeswap status"
            echo "  claudeswap test-models zai"
            echo "  claudeswap set zai glm-4.6"
            echo "  claudeswap setup"
            echo ""
            ;;
        *)
            if [[ -z "$command" ]]; then
                log_error "No command specified"
            else
                log_error "Unknown command: $command"
            fi
            echo "Use 'claudeswap help' for usage information"
            return 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"
